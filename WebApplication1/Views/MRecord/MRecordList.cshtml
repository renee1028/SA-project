@model IEnumerable<dynamic>
@{
    ViewData["Title"] = "MRecordList";
    var doctorSpecializations = ViewData["DoctorSpecializations"] as List<string>;
    var doctorNames = ViewData["DoctorNames"] as List<string>;
}
<script>
    function filterBySpecialization() {
        var specialization = document.getElementById("doctorSpecialization").value;

        // 發送AJAX請求，獲取該科別有病歷記錄的所有醫師
        fetch('@Url.Action("GetDoctorsBySpecialization", "MRecord")' + '?specialization=' + specialization)
            .then(response => response.json())
            .then(data => {
                if (data.doctors) {  // 確保資料有返回
                    var doctorNameSelect = document.getElementById("doctorName");
                    doctorNameSelect.innerHTML = '<option value="">選擇醫生</option>'; // 清空醫生選項

                    // 填充新的醫生選項
                    data.doctors.forEach(function (doctor) {
                        var option = document.createElement("option");
                        option.value = doctor;
                        option.textContent = doctor;
                        doctorNameSelect.appendChild(option);
                    });
                } else {
                    console.error("返回的資料格式不正確！");
                }
            })
            .catch(error => {
                console.error("Error fetching doctors:", error);// 可以顯示一個錯誤提示或警告給用戶
            });
    }
    function submitSearch() {
        var specialization = document.getElementById("doctorSpecialization").value;
        var doctorName = document.getElementById("doctorName").value;
        var recordDate = document.getElementById("recordDate").value;

        // 確保傳遞過濾條件給後端
        var url = '@Url.Action("MRecordList", "MRecord")' + '?specialization=' + specialization + '&doctorName=' + doctorName + '&recordDate=' + recordDate;

        window.location.href = url; // 這樣會發送請求並重新加載頁面
    }
</script>

<p style="font-size: 25px;"><img src="~/images/mrecord.png" width="30px" class="d-inline-block align-text-top" alt="病歷資料">查詢病歷</p>
<hr />

<div style="display: flex; align-items: center; gap: 20px; flex-wrap: wrap;">
    <div style="display: flex; align-items: center;">
        <label for="doctorSpecialization" style="margin-right: 10px; white-space: nowrap;">科別：</label>
        <select id="doctorSpecialization" class="form-control" onchange="filterBySpecialization()">
            <option value="">選擇科別</option>
            @foreach (var specialization in doctorSpecializations)
            {
                <option value="@specialization">@specialization</option>
            }
        </select>
    </div>

    <div style="display: flex; align-items: center;">
        <label for="doctorName" style="margin-right: 10px; white-space: nowrap;">醫生名稱：</label>
        <select id="doctorName" class="form-control">
            <option value="">選擇醫生</option>
        </select>
    </div>

    <div style="display: flex; align-items: center;">
        <label for="recordDate" style="margin-right: 10px; white-space: nowrap;">就診日期：</label>
        <input type="date" id="recordDate" class="form-control" onchange="filterRecords()" />
    </div>

    <a class="nav-link text-dark" href="#" onclick="submitSearch()">
        <img src="/images/searchL.png" width="50" class="d-inline-block align-text-top" alt="查詢條件" style="border-radius: 10px;">
    </a>
</div>

<table class="table table-striped table-bordered table-hover">
    <thead>
        <tr>
            <th>就診日期</th>
            <th>科別</th>
            <th>看診醫師</th>
            <th>症狀</th>
            <th>治療</th>
            <th>下載</th>
        </tr>
    </thead>
     <tbody>
        @foreach (var record in Model)
        {
            <tr>
                <td>@record.MRecord_date.ToString("yyyy-MM-dd")</td>
                <td>@record.Doctor_specialization</td>
                <td>@record.Doctor_name</td>
                <td>@record.MRecord_diagnosis</td>
                <td>@record.MRecord_treatmentplan</td>
                <td>
                    <form method="get" asp-action="Details" asp-route-id="@record.MRecord_id">
                        <button type="submit" class="btn btn-primary">查看詳情</button>
                    </form>
                </td>
            </tr>
        }
    </tbody>
</table>
@if (ViewData["Message"] != null)
{
    <div class="alert alert-warning" role="alert">
        @ViewData["Message"]
    </div>
}